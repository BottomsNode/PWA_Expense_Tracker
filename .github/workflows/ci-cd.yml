---
name: CI â†’ Android Build â†’ Optional Release (Cyberpunk)

# Triggers: branch pushes, tags starting with v, PRs, manual
on:
  push:
    branches: [main, dev]
    tags: ['v*']
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

concurrency:
  group: cyberpunk-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'
  BUN_VERSION: '1.3.2'
  APK_MIN_SIZE_BYTES: 100000
  ARTIFACT_RETENTION_DAYS: 14
  CYBER_ACENT: '\033[95m'   # neon magenta
  CYBER_OK: '\033[92m'      # neon green
  CYBER_WARN: '\033[93m'    # neon yellow
  CYBER_FAIL: '\033[91m'    # neon red
  CYBER_RST: '\033[0m'

########################
# CI: LINT / TYPECHECK / TEST / WEB BUILD
########################
jobs:
  ci:
    name: "CI â€” Lint Â· Typecheck Â· Test Â· Web Build"
    runs-on: ubuntu-latest
    outputs:
      web_artifact: web-build
    steps:
      - name: "â¤´ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âœ¨ Announce (theme)"
        run: |
          echo -e "${{ env.CYBER_ACENT }}â”â”â” CYBERPUNK CI: BOOTING â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${{ env.CYBER_RST }}"
          echo "::group::ğŸ›°ï¸ Environment"
          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"
          echo "Event: $GITHUB_EVENT_NAME"
          echo "::endgroup::"

      - name: "âš™ï¸ Setup Bun (fast runtime)"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # Bun/node caches: split keys for better hit rates
      - name: "ğŸ“¦ Restore Bun / node_modules / vite cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            node_modules
            .vite
            node_modules/.cache
          key: bun-node-${{ runner.os }}-${{ hashFiles('**/bun.lockb','**/package.json') }}
          restore-keys: |
            bun-node-${{ runner.os }}-

      - name: "â¬‡ï¸ Install dependencies"
        run: |
          echo "::group::ğŸ”§ Installing dependencies"
          echo -e "${{ env.CYBER_ACENT }}â–¸ bun install --frozen-lockfile${{ env.CYBER_RST }}"
          bun install --frozen-lockfile
          echo "::endgroup::"

      - name: "ğŸ” Lint (ESLint)"
        run: |
          echo "::group::ğŸ§¹ Lint"
          echo -e "${{ env.CYBER_ACENT }}â–¸ Running ESLint${{ env.CYBER_RST }}"
          set -o pipefail
          bunx eslint . --max-warnings=0 || (echo -e "${{ env.CYBER_FAIL }}âœ— Lint failed${{ env.CYBER_RST }}" && exit 1)
          echo -e "${{ env.CYBER_OK }}âœ“ Lint passed${{ env.CYBER_RST }}"
          echo "::endgroup::"

      - name: "ğŸ§¾ TypeScript check"
        run: |
          echo "::group::ğŸ“ Typecheck"
          bunx tsc --noEmit || (echo -e "${{ env.CYBER_FAIL }}âœ— Typecheck failed${{ env.CYBER_RST }}" && exit 1)
          echo -e "${{ env.CYBER_OK }}âœ“ Typecheck passed${{ env.CYBER_RST }}"
          echo "::endgroup::"

      - name: "ğŸ§ª Tests"
        run: |
          echo "::group::ğŸ§ª Tests"
          set -o pipefail
          bunx vitest run --coverage || echo -e "${{ env.CYBER_WARN }}No tests or some tests failed (check logs)${{ env.CYBER_RST }}"
          echo "::endgroup::"

      - name: "ğŸŒ Build web (Vite)"
        run: |
          echo "::group::ğŸŒ Building Web (Vite)"
          echo -e "${{ env.CYBER_ACENT }}â–¸ bun run build${{ env.CYBER_RST }}"
          bun run build
          echo -e "${{ env.CYBER_OK }}âœ“ Web build complete${{ env.CYBER_RST }}"
          echo "::endgroup::"

      - name: "ğŸ“¦ Package dist â†’ dist.zip"
        run: |
          echo "::group::ğŸ“¦ Packaging"
          if [ -d dist ]; then
            cd dist
            zip -r ../dist.zip . || true
            cd ..
            echo -e "${{ env.CYBER_OK }}âœ“ dist.zip created${{ env.CYBER_RST }}"
          else
            echo -e "${{ env.CYBER_FAIL }}âœ— dist missing${{ env.CYBER_RST }}"
            exit 1
          fi
          echo "::endgroup::"

      - name: "ğŸ—„ï¸ Upload web artifact"
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: "ğŸ“œ Write CI summary"
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: $GITHUB_REF" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- Web artifact: web-build" >> $GITHUB_STEP_SUMMARY

########################
# ANDROID BUILD (consumes web artifact)
########################
  android:
    name: "Android Build Â· Sign APK"
    runs-on: ubuntu-latest
    needs: ci
    if: ${{ needs.ci.result == 'success' }}
    steps:
      - name: "â¤´ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node (for Capacitor) & Bun"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: "âœ¨ Setup Bun"
        uses: oven-sh/setup-bun@v2

      - name: "â˜• Setup Java"
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: "ğŸ› ï¸ Restore Gradle cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
            android/.gradle-build-cache
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties','**/build.gradle*','**/settings.gradle*') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: "ğŸ§­ Setup Android SDK"
        uses: android-actions/setup-android@v3

      - name: "ğŸ” Decode keystore (secure)"
        run: |
          echo "::group::ğŸ” Keystore"
          mkdir -p android/app
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 || '' }}" ]; then
            echo -e "${{ env.CYBER_FAIL }}ERROR: ANDROID_KEYSTORE_BASE64 not set${{ env.CYBER_RST }}" >&2
            exit 1
          fi
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore
          echo "::endgroup::"

      - name: "ğŸ§¾ Export signing env"
        run: |
          echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS_PASSWORD=${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}" >> $GITHUB_ENV

      - name: "ğŸ“¥ Download web-build artifact"
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: .

      - name: "ğŸ“‚ Unpack web build"
        run: |
          echo "::group::ğŸ“‚ Unpack web-build"
          ls -la dist.zip || true
          unzip -q dist.zip -d dist || true
          echo "::endgroup::"

      - name: "ğŸ” Capacitor: copy & sync (android)"
        run: |
          echo "::group::ğŸ” Capacitor sync"
          if [ -x "./node_modules/.bin/cap" ]; then
            ./node_modules/.bin/cap copy
            ./node_modules/.bin/cap sync android
          elif command -v npx >/dev/null 2>&1; then
            npx cap copy
            npx cap sync android
          else
            echo -e "${{ env.CYBER_FAIL }}ERROR: Capacitor CLI not found${{ env.CYBER_RST }}" >&2
            exit 1
          fi
          echo "::endgroup::"

      - name: "ğŸ§° Build Signed Release APK"
        run: |
          echo "::group::ğŸ§° Gradle build"
          cd android
          chmod +x gradlew
          # enable daemon + configure build cache usage if available
          ./gradlew assembleRelease --no-daemon --stacktrace
          echo "::endgroup::"

      - name: "ğŸ” Verify and inline rename APK"
        id: rename
        run: |
          echo "::group::ğŸ” Verify APK"
          APK="android/app/build/outputs/apk/release/app-release.apk"
          if [ ! -f "$APK" ]; then
            echo -e "${{ env.CYBER_FAIL }}âœ— APK missing at $APK${{ env.CYBER_RST }}" >&2
            ls -la android/app/build/outputs || true
            exit 1
          fi

          # portable size check
          if stat --version >/dev/null 2>&1; then
            SIZE=$(stat -c%s "$APK")
          else
            SIZE=$(stat -f%z "$APK")
          fi

          if [ "$SIZE" -lt ${{ env.APK_MIN_SIZE_BYTES }} ]; then
            echo -e "${{ env.CYBER_FAIL }}âœ— APK too small ($SIZE bytes). Threshold: ${{ env.APK_MIN_SIZE_BYTES }}${{ env.CYBER_RST }}" >&2
            exit 1
          fi

          OUT="expense-tracker-${GITHUB_SHA:0:7}.apk"
          mkdir -p artifacts
          cp "$APK" "artifacts/$OUT"
          echo "apk_path=artifacts/$OUT" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          echo -e "${{ env.CYBER_OK }}âœ“ APK verified and copied â†’ artifacts/$OUT${{ env.CYBER_RST }}"

      - name: "ğŸ—„ï¸ Upload android-apk artifact"
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.rename.outputs.apk_path }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: "ğŸ“œ Android step summary"
        run: |
          echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- APK artifact: android-apk" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- APK size threshold: ${{ env.APK_MIN_SIZE_BYTES }} bytes" >> $GITHUB_STEP_SUMMARY

########################
# RELEASE: create GitHub Release only on semver tags (v*)
########################
  release:
    name: "Release (tags only)"
    runs-on: ubuntu-latest
    needs: android
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: "â¤´ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ“¥ Download APK artifact"
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/

      - name: "ğŸ“ Generate changelog"
        id: changelog
        run: |
          echo "::group::ğŸ“ Generating changelog"
          TAG="${GITHUB_REF#refs/tags/}"
          PREV=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)
          if [ -n "$PREV" ]; then
            git log "$PREV"..HEAD --pretty=format:"- %s (%h)" > CHANGELOG.md
          else
            git log --pretty=format:"- %s (%h)" --max-count=200 > CHANGELOG.md
          fi
          echo "::endgroup::"
          echo "changelog_path=CHANGELOG.md" >> $GITHUB_OUTPUT

      - name: "ğŸš€ Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.apk
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "âœ… Release summary"
        run: |
          echo "## Release created: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
          echo "- Attached artifacts: artifacts/*.apk" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG: ${{ steps.changelog.outputs.changelog_path }}" >> $GITHUB_STEP_SUMMARY

########################
# END: Global cleanup/message
########################
  final:
    name: "Final Neon Echo"
    runs-on: ubuntu-latest
    needs: [ci]
    if: ${{ always() }}
    steps:
      - name: "ğŸ§¾ Dump run summary (neon)"
        run: |
          echo -e "${{ env.CYBER_ACENT }}â”â”â” RUN SUMMARY â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${{ env.CYBER_RST }}"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Ref: $GITHUB_REF"
          echo "Result: ${{ job.status || 'unknown' }}"
          echo -e "${{ env.CYBER_ACENT }}â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${{ env.CYBER_RST }}"
