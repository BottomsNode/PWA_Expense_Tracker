name: CI Pipeline

on:
  # Trigger CI on pushes to main/dev and on version tags like v1.2.3
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

# Prevent multiple concurrent runs for same branch/tag
concurrency:
  group: ci-pipeline-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  ARTIFACT_RETENTION_DAYS: 14
  BUN_VERSION: "1.3.2"

jobs:

  ################################################################################
  # SECRET SCAN
  ################################################################################
  secret-scan:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  ################################################################################
  # LINT
  ################################################################################
  lint:
    runs-on: ubuntu-latest
    needs: secret-scan
    outputs:
      lint_status: ${{ steps.eslint_out.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore Bun/node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            node_modules
          key: bun-ci-${{ runner.os }}-${{ hashFiles('**/bun.lockb','**/package.json') }}
          restore-keys: |
            bun-ci-${{ runner.os }}-
            bun-ci-

      - name: Install deps (bun)
        run: bun install --frozen-lockfile

      - name: Run ESLint
        id: eslint_out
        run: |
          set +e
          bunx eslint . --max-warnings=0
          echo "status=$([[ $? -eq 0 ]] && echo success || echo failure)" >> $GITHUB_OUTPUT

      - name: Upload ESLint cache (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-cache-${{ github.sha }}
          path: .eslintcache
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  ################################################################################
  # TYPECHECK
  ################################################################################
  typecheck:
    runs-on: ubuntu-latest
    needs: secret-scan
    outputs:
      type_status: ${{ steps.ts_out.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore Bun/node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            node_modules
          key: bun-ci-${{ runner.os }}-${{ hashFiles('**/bun.lockb','**/package.json') }}
          restore-keys: |
            bun-ci-${{ runner.os }}-
            bun-ci-

      - name: Install deps (bun)
        run: bun install --frozen-lockfile

      - name: Run TypeScript check
        id: ts_out
        run: |
          set +e
          bunx tsc --noEmit
          echo "status=$([[ $? -eq 0 ]] && echo success || echo failure)" >> $GITHUB_OUTPUT

  ################################################################################
  # TESTS
  ################################################################################
  test:
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore Bun cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            node_modules
          key: bun-test-${{ runner.os }}-${{ hashFiles('**/bun.lockb','**/package.json') }}
          restore-keys: |
            bun-test-${{ runner.os }}-
            bun-test-

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Run tests + coverage (ignore no-test failure)
        run: |
          bunx vitest run --coverage || echo "No tests found â€” skipping"

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.sha }}
          path: coverage
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  ################################################################################
  # BUILD WEB
  ################################################################################
  build-web:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    outputs:
      web_artifact: web-build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore Bun & Vite cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            node_modules
            .vite
            node_modules/.cache
          key: bun-web-${{ runner.os }}-${{ hashFiles('**/bun.lockb','**/package.json','**/vite.config.*') }}
          restore-keys: |
            bun-web-${{ runner.os }}-
            bun-web-

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Basic PWA manifest check
        run: |
          if [ -f public/manifest.json ]; then
            jq -e '.name and .start_url and .icons' public/manifest.json || echo "WARNING: manifest incomplete"
          else
            echo "WARNING: public/manifest.json not found"
          fi

      - name: Build (Vite)
        run: bun run build

      - name: Pack dist into zip
        run: |
          if [ -d dist ]; then
            cd dist
            zip -r ../dist.zip . || true
            cd ..
          else
            echo "ERROR: dist missing" >&2
          exit 1
          fi

      - name: Verify dist.zip exists
        run: |
          if [ ! -f dist.zip ]; then
            echo "ERROR: dist.zip not found" >&2
            exit 1
          fi
          du -sh dist || true

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

  ################################################################################
  # Canary (PR only)
  ################################################################################
  canary:
    needs: build-web
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: .

      - name: Unpack dist
        run: |
          unzip -q dist.zip -d preview-dist || true

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-web-${{ github.sha }}
          path: preview-dist/**
          retention-days: 7

  ################################################################################
  # PR Summary (deduped)
  ################################################################################
  pr-summary:
    needs: [lint, typecheck]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const lint = "${{ needs.lint.outputs.lint_status }}";
            const ts = "${{ needs.typecheck.outputs.type_status }}";

            const body = `## CI Summary
            | Check | Status |
            |------|--------|
            | ESLint | **${lint}** |
            | TypeScript | **${ts}** |

            Artifacts:
            - web-build
            - coverage report

            _This comment is auto-generated._`;

                        // find existing bot comment
                        const comments = await github.rest.issues.listComments({ owner, repo, issue_number: pr.number });
                        const botComment = comments.data.find(c => c.user && c.user.type === 'Bot' && c.body && c.body.includes('## CI Summary'));
                        if (botComment) {
                          await github.rest.issues.updateComment({ owner, repo, comment_id: botComment.id, body });
                        } else {
                          await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });
                        }
