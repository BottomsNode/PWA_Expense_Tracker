name: Daily Security Check

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      min_severity:
        description: "Minimum severity to trigger failure (low|moderate|high|critical)"
        required: false
        default: "moderate"
      dry_run:
        description: "If true, do NOT create issues or fail the workflow"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

env:
  FORCE_COLOR: "1"
  DEFAULT_SEVERITY: "moderate"

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Read workflow inputs
        id: inputs
        run: |
          CYAN="\033[36m"
          RESET="\033[0m"

          echo -e "${CYAN}Reading workflow input values...${RESET}"

          SEV="${{ github.event.inputs.min_severity }}"
          DRY="${{ github.event.inputs.dry_run }}"

          if [ -z "$SEV" ]; then SEV="${DEFAULT_SEVERITY}"; fi
          if [ -z "$DRY" ]; then DRY="false"; fi

          echo "severity=$SEV" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY" >> $GITHUB_OUTPUT

          echo -e "â€¢ Severity threshold: ${CYAN}$SEV${RESET}"
          echo -e "â€¢ Dry run mode: ${CYAN}$DRY${RESET}"

      - name: Run Bun audit (JSON mode)
        id: audit
        continue-on-error: true
        run: |
          MAGENTA="\033[35m"
          CYAN="\033[36m"
          RESET="\033[0m"

          echo -e "${MAGENTA}Running Bun security audit...${RESET}"

          bun audit --json > audit-results.json || true

          TOTAL=$(grep -o '"severity":"' audit-results.json | wc -l || echo 0)

          CRITICAL=$(grep -c '"severity":"critical"' audit-results.json || echo 0)
          HIGH=$(grep -c '"severity":"high"' audit-results.json || echo 0)
          MODERATE=$(grep -c '"severity":"moderate"' audit-results.json || echo 0)
          LOW=$(grep -c '"severity":"low"' audit-results.json || echo 0)

          echo "total_vulns=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo -e "${CYAN}Vulnerabilities detected:${RESET}"
          echo -e "  â€¢ Critical:   $CRITICAL"
          echo -e "  â€¢ High:       $HIGH"
          echo -e "  â€¢ Moderate:   $MODERATE"
          echo -e "  â€¢ Low:        $LOW"

      - name: Decide if workflow should fail
        id: decision
        run: |
          RED="\033[31m"
          GREEN="\033[32m"
          YELLOW="\033[33m"
          CYAN="\033[36m"
          RESET="\033[0m"

          SEV="${{ steps.inputs.outputs.severity }}"
          DRY="${{ steps.inputs.outputs.dry_run }}"

          CRITICAL=${{ steps.audit.outputs.critical }}
          HIGH=${{ steps.audit.outputs.high }}
          MODERATE=${{ steps.audit.outputs.moderate }}

          FAIL=false

          case "$SEV" in
            critical)
              [ "$CRITICAL" -gt 0 ] && FAIL=true
              ;;
            high)
              [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ] && FAIL=true
              ;;
            moderate)
              [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ] || [ "$MODERATE" -gt 0 ] && FAIL=true
              ;;
            low)
              [ "${{ steps.audit.outputs.total_vulns }}" -gt 0 ] && FAIL=true
              ;;
          esac

          echo "should_fail=$FAIL" >> $GITHUB_OUTPUT

          if [ "$FAIL" = true ]; then
            echo -e "${RED}âŒ Vulnerabilities exceed threshold${RESET}"
          else
            echo -e "${GREEN}âœ” Within acceptable security limits${RESET}"
          fi

          if [ "$DRY" = "true" ]; then
            echo -e "${YELLOW}[DRY RUN] Ignoring failure result${RESET}"
            echo "should_fail=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update GitHub Issue (only on failure)
        if: steps.decision.outputs.should_fail == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('audit-summary.md', 'utf8');
            const repo = context.repo;

            console.log("\x1b[33mChecking for existing security issues...\x1b[0m");

            const issues = await github.rest.issues.listForRepo({
              owner: repo.owner,
              repo: repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const existing = issues.data.find(issue =>
              issue.title.includes('Security vulnerabilities detected')
            );

            if (existing) {
              console.log("\x1b[36mUpdating existing security issue...\x1b[0m");
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: existing.number,
                body: `### New Audit (${new Date().toISOString()})\n\n${summary}`
              });
            } else {
              console.log("\x1b[35mCreating new security issue...\x1b[0m");
              await github.rest.issues.create({
                owner: repo.owner,
                repo: repo.repo,
                title: 'ðŸš¨ Security vulnerabilities detected',
                body: summary,
                labels: ['security', 'dependencies', 'urgent']
              });
            }

      - name: Fail workflow if vulnerabilities exceed threshold
        if: steps.decision.outputs.should_fail == 'true'
        run: |
          RED="\033[31m"
          RESET="\033[0m"
          echo -e "${RED}âŒ Security vulnerabilities exceed threshold. Check created issue.${RESET}"
          exit 1

      - name: Final Summary (Success)
        if: steps.decision.outputs.should_fail == 'false'
        run: |
          GREEN="\033[32m"
          RESET="\033[0m"

          # Console output WITH COLOR
          echo -e "${GREEN}âœ” No actionable vulnerabilities detected.${RESET}"

          # Summary output WITHOUT COLOR (GitHub UI cannot display ANSI codes)
          {
            echo "## Security Check"
            echo ""
            echo "âœ” No actionable vulnerabilities detected."
            echo ""
            echo "See uploaded artifact for full results."
          } >> $GITHUB_STEP_SUMMARY

