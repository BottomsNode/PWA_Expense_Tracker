name: Daily Security Check

on:
  schedule:
    - cron: "0 9 * * *" # daily at 9 AM
  workflow_dispatch:

env:
  FORCE_COLOR: "1" # enable colored output

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: ğŸŸ¦ Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: ğŸ“‹ Run Bun security audit
        id: audit
        continue-on-error: true
        run: |
          echo -e "\033[36m[INFO] Starting security audit at $(date -u)...\033[0m"

          echo "::group::Running bun audit"
          bun audit --json > audit-results.json || true
          echo "::endgroup::"

          # Detect vulnerabilities
          if grep -q '"vulnerabilities"' audit-results.json; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            echo -e "\033[31m[WARNING] Vulnerabilities detected!\033[0m"
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo -e "\033[32m[OK] No vulnerabilities found.\033[0m"
          fi

          echo "## Security Audit Summary ($(date -u))" > audit-summary.md
          echo "" >> audit-summary.md

          echo "::group::Readable Report"
          bun audit >> audit-summary.md 2>&1 || true
          echo "::endgroup::"

      - name: ğŸ“¦ Upload audit logs
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: security-audit-${{ github.run_id }}
          path: |
            audit-results.json
            audit-summary.md
          retention-days: 30

      - name: ğŸ›‘ Create or update security issue
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('audit-summary.md', 'utf8');

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: "security,dependencies",
              state: "open"
            });

            const existing = issues.data.find(i => 
              i.title.includes("Security vulnerabilities detected")
            );

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `### New Audit (${new Date().toISOString()})\n\n${body}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸš¨ Security vulnerabilities detected",
                body,
                labels: ["security", "dependencies", "urgent"]
              });
            }

      - name: âŒ Fail workflow if vulnerabilities exist
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        run: |
          echo -e "\033[31m[ERROR] Security issues found. Failing workflow.\033[0m"
          exit 1
