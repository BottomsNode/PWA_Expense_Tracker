name: Cache Prewarm

on:
  schedule:
    - cron: "0 2 * * *" # 02:00 UTC daily
  workflow_dispatch:

env:
  PREWARM_CACHE_PREFIX: "prewarm"
  JAVA_VERSION: "21"
  JAVA_DISTRIBUTION: "temurin"

jobs:
  prewarm:
    name: Prewarm Bun + Gradle + Vite
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: Restore Bun cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun
          key: ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-

      - run: bun install --frozen-lockfile

      - name: Warm Vite build cache
        run: bun run build --silent || true

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Warm Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ env.PREWARM_CACHE_PREFIX }}-gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ env.PREWARM_CACHE_PREFIX }}-gradle-${{ runner.os }}-
