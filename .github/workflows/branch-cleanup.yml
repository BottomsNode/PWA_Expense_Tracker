name: Branch Cleanup

on:
  pull_request:
    types: [closed]
  schedule:
    - cron: "0 0 * * 0" # every Sunday at midnight
  workflow_dispatch:

env:
  FORCE_COLOR: "1"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”„ Fetch all branches
        run: git fetch --all --prune

      # ------------------------------------------------------------
      # DELETE MERGED DEPENDABOT BRANCHES
      # ------------------------------------------------------------
      - name: ðŸ§¹ Remove merged Dependabot branches
        id: merged
        run: |
          echo "::group::Checking merged branches"
          echo -e "\033[36m[INFO] Started at $(date -u)\033[0m"

          MERGED=$(git branch -r --merged origin/main | sed 's|origin/||' | grep '^dependabot/' || true)
          echo "$MERGED" > merged-branches.txt

          if [ -z "$MERGED" ]; then
            echo "merged_count=0" >> $GITHUB_OUTPUT
            echo -e "\033[32m[OK] No merged branches.\033[0m"
          else
            COUNT=0
            for b in $MERGED; do
              echo -e "\033[33mDeleting merged: $b\033[0m"
              git push origin --delete "$b" || true
              COUNT=$((COUNT+1))
            done
            echo "merged_count=$COUNT" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      # ------------------------------------------------------------
      # DELETE STALE (>30 DAYS) DEPENDABOT BRANCHES
      # ------------------------------------------------------------
      - name: ðŸ—‘ Remove stale branches (>30 days)
        id: stale
        run: |
          echo "::group::Checking stale branches"
          NOW=$(date +%s)
          LIMIT=$((NOW - 2592000))
          STALE_LIST=""

          for b in $(git branch -r | sed 's|origin/||' | grep '^dependabot/' || true); do
            LAST=$(git log -1 --format=%ct origin/$b 2>/dev/null || echo 0)

            if [ "$LAST" -lt "$LIMIT" ] && [ "$LAST" -ne 0 ]; then
              DAYS=$(( (NOW - LAST) / 86400 ))
              echo -e "\033[31mDeleting stale: $b (${DAYS} days old)\033[0m"
              git push origin --delete "$b" || true
              STALE_LIST="$STALE_LIST$b ($DAYS days)\n"
            fi
          done

          echo -e "$STALE_LIST" > stale-branches.txt
          echo "stale_count=$(wc -l < stale-branches.txt)" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      # ------------------------------------------------------------
      # Upload cleanup logs
      # ------------------------------------------------------------
      - name: ðŸ“¦ Upload cleanup logs
        uses: actions/upload-artifact@v5
        with:
          name: branch-cleanup-${{ github.run_id }}
          path: |
            merged-branches.txt
            stale-branches.txt
          retention-days: 14

      # ------------------------------------------------------------
      # GitHub Summary
      # ------------------------------------------------------------
      - name: ðŸ§¾ Summary
        run: |
          echo "## ðŸ§¹ Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Merged branches deleted:** ${{ steps.merged.outputs.merged_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stale branches deleted:** ${{ steps.stale.outputs.stale_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deleted Merged Branches" >> $GITHUB_STEP_SUMMARY
          cat merged-branches.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deleted Stale Branches" >> $GITHUB_STEP_SUMMARY
          cat stale-branches.txt >> $GITHUB_STEP_SUMMARY
