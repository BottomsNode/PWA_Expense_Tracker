# Security Check

This workflow performs automated security scanning of project dependencies to identify and track vulnerabilities.

## Overview

The security check workflow runs daily dependency audits using Bun's built-in security scanner, detecting vulnerabilities and creating GitHub issues for tracking and remediation.

## Triggers

### Automatic
- **Scheduled**: Daily at 09:00 UTC

### Manual
- `workflow_dispatch`: Can be triggered manually from GitHub Actions UI

## Workflow Steps

### 1. Repository Checkout
Clones the repository to access dependency manifests.

### 2. Bun Installation
Installs the latest version of Bun runtime.

### 3. Dependency Installation
Installs project dependencies to enable accurate scanning.

**Command**: `bun install`

### 4. Security Audit
Runs Bun's audit command to scan for known vulnerabilities.

**Command**: `bun audit --json`

**Output**: JSON report containing:
- Vulnerability details
- Severity levels (low, moderate, high, critical)
- Affected packages
- Remediation suggestions

### 5. Issue Creation
Creates a GitHub issue if vulnerabilities exceed the configured severity threshold.

**Issue Contents**:
- List of vulnerable packages
- Severity ratings
- Affected versions
- Recommended fixes
- Links to security advisories

## Severity Levels

Vulnerabilities are classified by severity:

| Severity | Description | Action Required |
|----------|-------------|-----------------|
| **Critical** | Exploitable, immediate risk | Fix immediately |
| **High** | Significant risk | Fix within 7 days |
| **Moderate** | Potential risk | Fix within 30 days |
| **Low** | Minor risk | Fix during regular maintenance |

### Threshold Configuration

Currently, issues are created for:
- **Critical** severity and above

To adjust:
```yaml
env:
  SEVERITY_THRESHOLD: "high"  # Options: low, moderate, high, critical
```

## Artifacts

This workflow does not produce downloadable artifacts. All output is in the form of GitHub issues.

## Issue Management

### Issue Format

Created issues follow this template:

**Title**: `Security Alert: [N] vulnerabilities detected`

**Body**:
```markdown
## Security Scan Results

Scan Date: 2024-01-15
Severity: High

### Vulnerabilities Found

1. **package-name** (v1.2.3)
   - Severity: High
   - CVE: CVE-2024-12345
   - Description: [Brief description]
   - Fix: Upgrade to v1.2.4

[... additional vulnerabilities ...]

### Recommended Actions

1. Review each vulnerability
2. Update affected packages
3. Test application after updates
4. Re-run security scan to verify fixes

---
*Generated by automated security scan*
```

### Issue Lifecycle

1. **Created**: When vulnerabilities are detected
2. **Assigned**: Assign to security team or maintainer
3. **In Progress**: While fixes are being implemented
4. **Closed**: After all vulnerabilities are resolved

### Duplicate Prevention

The workflow checks for existing open security issues before creating a new one to avoid duplication.

## Remediation Guide

### Step 1: Review the Issue
1. Open the created GitHub issue
2. Review each vulnerability
3. Assess impact on your application

### Step 2: Update Dependencies
```bash
# Update specific package
bun update package-name

# Update all dependencies
bun update

# Check for outdated packages
bun outdated
```

### Step 3: Test Changes
```bash
# Run tests
bun test

# Build application
bun run build

# Manual testing
```

### Step 4: Verify Fix
```bash
# Re-run security audit
bun audit

# Should show no vulnerabilities above threshold
```

### Step 5: Close Issue
Once verified:
1. Commit and push changes
2. Reference the issue in commit: `fix: resolve security vulnerabilities (fixes #123)`
3. Close the issue with resolution notes

## Failure Scenarios

### Audit Command Failure
**Symptom**: `bun audit` exits with error

**Causes**:
- Corrupted `package.json` or `bun.lockb`
- Network issues accessing vulnerability database
- Bun version incompatibility

**Resolution**:
1. Verify `package.json` is valid JSON
2. Delete `node_modules/` and reinstall: `bun install`
3. Update Bun to latest version
4. Check network connectivity

### Issue Creation Failure
**Symptom**: Vulnerabilities detected but no issue created

**Causes**:
- Missing `issues: write` permission
- API rate limiting
- Invalid issue template

**Resolution**:
1. Verify workflow permissions in repository settings
2. Check GitHub API status
3. Review workflow logs for detailed errors

### False Positives
**Symptom**: Vulnerabilities reported for packages not directly used

**Causes**:
- Transitive dependencies (dependencies of dependencies)
- Development-only vulnerabilities

**Resolution**:
1. Review if the vulnerability affects production code
2. Check if the package is only a dev dependency
3. Consider if the vulnerable code path is reachable
4. Document reasoning if choosing not to fix

## Best Practices

### Immediate Response
- **Critical vulnerabilities**: Fix within 24 hours
- **High vulnerabilities**: Fix within 1 week
- **Moderate vulnerabilities**: Fix within 30 days
- **Low vulnerabilities**: Address during regular updates

### Dependency Management
1. **Keep dependencies updated**: Regular updates reduce vulnerability surface
2. **Minimize dependencies**: Fewer dependencies = less attack surface
3. **Audit before adding**: Check package reputation before adding new dependencies
4. **Use lock files**: Commit `bun.lockb` to ensure consistent dependency versions

### Security Workflow
1. **Subscribe to security advisories**: Enable GitHub security alerts
2. **Review Dependabot PRs promptly**: Don't let security updates pile up
3. **Test thoroughly**: Ensure updates don't break functionality
4. **Document exceptions**: If you can't fix immediately, document why

### Team Communication
1. **Assign issues**: Ensure someone owns each security issue
2. **Set SLAs**: Define response times for each severity level
3. **Post-incident reviews**: Learn from security incidents
4. **Share knowledge**: Document remediation steps for common issues

## Configuration

### Scan Frequency

To change scan frequency:

```yaml
on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 09:00 UTC
    # - cron: '0 9 * * 1'  # Weekly (Mondays)
    # - cron: '0 9 1 * *'  # Monthly (1st of month)
```

### Severity Threshold

To adjust which severities trigger issues:

```yaml
env:
  SEVERITY_THRESHOLD: "moderate"  # Lower threshold, more alerts
```

### Issue Assignment

To auto-assign issues to specific users:

```yaml
- name: Create Issue
  with:
    assignees: security-team,lead-developer
```

## Integration with Other Tools

### Dependabot
Dependabot complements this workflow by automatically creating PRs for vulnerable dependencies.

Enable in `.github/dependabot.yml`:
```yaml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "daily"
    open-pull-requests-limit: 10
```

### GitHub Security Advisories
Enable GitHub's built-in security features:
1. Go to Settings â†’ Security & analysis
2. Enable Dependabot alerts
3. Enable Dependabot security updates

### External Scanners
Consider integrating:
- **Snyk**: Comprehensive vulnerability scanning
- **npm audit**: Additional Node.js-specific checks
- **OWASP Dependency-Check**: OWASP-maintained scanner

## Monitoring and Reporting

### Weekly Review
Establish a weekly security review:
1. Review all open security issues
2. Check progress on remediation
3. Update security documentation
4. Communicate status to team

### Metrics to Track
- Number of open vulnerabilities by severity
- Average time to remediation
- Percentage of dependencies with known vulnerabilities
- Number of false positives

### Dashboard Setup
Create a security dashboard using GitHub Projects:
1. Filter issues by `security` label
2. Group by severity
3. Track age and resolution time
4. Monitor trends over time

## Exclusions and Exceptions

### Accepted Risks
Document accepted security risks in `SECURITY.md`:

```markdown
## Accepted Security Risks

### package-name v1.2.3 (CVE-2024-12345)
- **Severity**: Moderate
- **Reason**: Vulnerability only affects Node.js < 12, we use Node 18+
- **Decision Date**: 2024-01-15
- **Reviewer**: security-team
- **Re-evaluation Date**: 2024-04-15
```

### Ignored Vulnerabilities
To ignore specific vulnerabilities (use sparingly):

```yaml
# In package.json (Bun doesn't support audit ignore yet)
# Consider documenting in SECURITY.md instead
```

## Troubleshooting

**Q: Why am I getting security alerts for dev dependencies?**  
A: Dev dependencies can still pose risks. Review if the vulnerability affects your development environment security.

**Q: Can I disable this workflow temporarily?**  
A: Yes, disable in Actions settings or comment out the schedule trigger. Document why and set a reminder to re-enable.

**Q: How do I know if a vulnerability affects my code?**  
A: Review the vulnerability description and check if your code uses the affected functionality. Consider using `bun why package-name` to see why it's installed.

**Q: What if I can't update the vulnerable package?**  
A: Document the risk, implement mitigations if possible, and set a timeline for finding alternatives.

**Q: Are transitive dependencies scanned?**  
A: Yes, `bun audit` scans all dependencies, including transitive ones.

**Q: How do I test if a vulnerability is actually exploitable in my app?**  
A: Review CVE details, check if vulnerable code paths are used, consider setting up a test environment to attempt exploitation (safely and ethically).